<!doctype html>
<html>
  <head>
    <title>Map Examples</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.0.0/ol.css" type="text/css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.0.0/ol-debug.css" type="text/css">
    <link rel="stylesheet" href="./samples.css" type="text/css" />
    <!-- font-awesome is an iconic font, which means we can draw resolution-independent icons -->
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  </head>
  <body>
    <div id="map" class="full-map"></div>
<!--    <div id="location" class="marker"><span class="icon-flag"></div> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.0.0/ol-debug.js" type="text/javascript"></script>
    <script>
      var defaultStroke = new ol.style.Stroke({
        color: '#fff',
        width: 2
      });

      var colours = [
        '#3399CC',
        '#f44242',  //red
        '#f4b942',  //orange
        '#f4fc00',  //yellow
        '#8ffc00',  //green
        '#00fc7e',  //green-blue
        '#00fcda',  //blue-green
        '#00acfc',  //blue
        '#b900fc',  //violet
        '#fc00b0',  //pink
      ];

      var osmTileLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
      });

      var london = ol.proj.transform([-0.12755, 51.507222], 'EPSG:4326', 'EPSG:3857');

      var view = new ol.View({
        center: london,
        zoom: 6
      });

      var ownPositionFeature = new ol.Feature();
      ownPositionFeature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
          radius: 6,
          fill: new ol.style.Fill({
            color: '#3399CC'
          }),
          stroke: defaultStroke
        }),
        text: new ol.style.Text({
          font: '14px sans-serif',
          offsetY: 10,
          text: 'You'
        })
      }));

      var positionLayerSource = new ol.source.Vector({
        features: [ownPositionFeature]
      });

      var positionLayer = new ol.layer.Vector({
//      map: map,
        source: positionLayerSource
      });

      var map = new ol.Map({
        target: 'map',
        layers: [
          osmTileLayer, 
          positionLayer
        ],
        view: view
      });

      // create a Geolocation object setup to track the position of the device
      var geolocation = new ol.Geolocation({
        tracking: true,
        projection: view.getProjection()
      });

      // bind the projection to the view so that positions are reported in the
      // projection of the view
      //  TODO: investigate whether this is needed
      geolocation.on('change:projection', view);

      // once we have a position for the first time, center the map on it
      geolocation.once('change:position', function() {
        var position = geolocation.getPosition();
        view.setCenter(position);
//        marker.setPosition(p);
//        view.setResolution(2.388657133911758);
      });

      // when the GeoLocation API provides a position update, move the point to new position
      geolocation.on('change:position', function() {
        var position = geolocation.getPosition();
        console.log(position);
        // position we get from geolocation is in another coordinates set, apparently.
        //  so here we're transforming 'em into a format, just like we did in the beginning,
        //  when defining the coordinates of London (the Capital of Great Britain)
//        view.setCenter(ol.proj.transform(p, 'EPSG:4326', 'EPSG:3857'));
//        marker.setPosition(p);
        if (position) { 
          ownPositionFeature.setGeometry(new ol.geom.Point(position));
          send_location(position);
        }
      });
    </script>

    <script type="text/javascript">
      var name = guid(); 

      var otherUsers = {};

      function server_response_handler(otherUserLocations) {
        for (var otherUserName in otherUserLocations) {
          if (!otherUserLocations.hasOwnProperty(otherUserName)) {
              //The current property is not a direct property of p
              continue;
          }
          var otherUserCoords = otherUserLocations[otherUserName];
          console.log(otherUserName, otherUserCoords);

          if (otherUsers[otherUserName]) {
            otherUsers[otherUserName]['latitude'] = otherUserCoords['latitude'];
            otherUsers[otherUserName]['longtitude'] = otherUserCoords['longtitude'];
          } else {
            var color = colours[Math.floor(Math.random() * (colours.length)) + 1];

            var userPositionFeature = new ol.Feature();
            userPositionFeature.setStyle(new ol.style.Style({
              image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({
                  color: color
                }),
                stroke: defaultStroke
              }),
              text: new ol.style.Text({
                font: '14px sans-serif',
                offsetY: 10,
                text: otherUserName
              })
            }));

            otherUsers[otherUserName] = {
              'latitude': otherUserCoords.latitude,
              'longtitude': otherUserCoords.longtitude,
              'color': color,
              'positionFeature': userPositionFeature
            }

            positionLayerSource.addFeature(userPositionFeature);
          }

          userPositionFeature = otherUsers[otherUserName]['positionFeature'];
          userPositionFeature.setGeometry(new ol.geom.Point([
            otherUsers[otherUserName]['latitude'],
            otherUsers[otherUserName]['longtitude']
          ]));
        }
      }

      function send_location(ol_position) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '../location');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
          if (xhr.status === 200) {
  //          var userInfo = JSON.parse(xhr.responseText);
            console.log(xhr.responseText);
            var otherUserLocations = JSON.parse(xhr.responseText);

            server_response_handler(otherUserLocations);
          }
        };

        xhr.send(JSON.stringify({
          'name': name,
          'latitude': ol_position[0],
          'longtitude': ol_position[1]
        }));
      }

      function guid() {
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
      }

      function s4() {
        return Math.floor((1 + Math.random()) * 0x10000)
          .toString(16)
          .substring(1);
      }      
    </script>
  </body>
</html>